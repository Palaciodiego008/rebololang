package controllers

import (
	"database/sql"
	"net/http"
	"time"
	
	"github.com/gorilla/mux"
	"github.com/Palaciodiego008/rebololang/pkg/rebolo"
	"{{.Module}}/models"
)

type {{.Name}}Controller struct{
	App *rebolo.Application
}

func (c *{{.Name}}Controller) Index(w http.ResponseWriter, r *http.Request) {
	db := c.App.DB()
	
	rows, err := db.QueryContext(r.Context(), 
		"SELECT id{{range .Fields}}, {{.DBName}}{{end}}, created_at, updated_at FROM {{.TableName}} ORDER BY created_at DESC")
	if err != nil {
		c.App.RenderError(w, "Failed to fetch {{.VarName}}s", http.StatusInternalServerError)
		return
	}
	defer rows.Close()
	
	var {{.VarName}}s []models.{{.Name}}
	for rows.Next() {
		var item models.{{.Name}}
		if err := rows.Scan(&item.ID{{range .Fields}}, &item.{{.Name | title}}{{end}}, &item.CreatedAt, &item.UpdatedAt); err != nil {
			continue
		}
		{{.VarName}}s = append({{.VarName}}s, item)
	}
	
	c.App.RenderHTML(w, "{{.ViewPath}}/index.html", map[string]interface{}{
		"{{.Name}}s": {{.VarName}}s,
	})
}

func (c *{{.Name}}Controller) Show(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id := vars["id"]
	
	db := c.App.DB()
	var item models.{{.Name}}
	
	err := db.QueryRowContext(r.Context(), 
		"SELECT id{{range .Fields}}, {{.DBName}}{{end}}, created_at, updated_at FROM {{.TableName}} WHERE id = ?", id).
		Scan(&item.ID{{range .Fields}}, &item.{{.Name | title}}{{end}}, &item.CreatedAt, &item.UpdatedAt)
	
	if err == sql.ErrNoRows {
		c.App.RenderError(w, "{{.Name}} not found", http.StatusNotFound)
		return
	} else if err != nil {
		c.App.RenderError(w, "Database error", http.StatusInternalServerError)
		return
	}
	
	c.App.RenderHTML(w, "{{.ViewPath}}/show.html", item)
}

func (c *{{.Name}}Controller) New(w http.ResponseWriter, r *http.Request) {
	c.App.RenderHTML(w, "{{.ViewPath}}/new.html", nil)
}

func (c *{{.Name}}Controller) Create(w http.ResponseWriter, r *http.Request) {
	if err := r.ParseForm(); err != nil {
		c.App.RenderError(w, "Invalid form data", http.StatusBadRequest)
		return
	}
	
{{range .Fields}}{{if eq .GoType "bool"}}	{{.DBName}} := r.FormValue("{{.FormName}}") == "true"
{{else if eq .GoType "int64"}}	{{.DBName}} := r.FormValue("{{.FormName}}")
{{else}}	{{.DBName}} := r.FormValue("{{.FormName}}")
{{end}}{{end}}	
	db := c.App.DB()
	_, err := db.ExecContext(r.Context(), 
		"INSERT INTO {{.TableName}} ({{range $i, $f := .Fields}}{{if $i}}, {{end}}{{$f.DBName}}{{end}}, created_at, updated_at) VALUES ({{range $i, $f := .Fields}}{{if $i}}, {{end}}?{{end}}, ?, ?)",
		{{range .Fields}}{{.DBName}}, {{end}}time.Now(), time.Now())
	
	if err != nil {
		c.App.RenderError(w, "Failed to create {{.VarName}}", http.StatusInternalServerError)
		return
	}
	
	http.Redirect(w, r, "/{{.RoutePath}}", http.StatusSeeOther)
}

func (c *{{.Name}}Controller) Edit(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id := vars["id"]
	
	db := c.App.DB()
	var item models.{{.Name}}
	
	err := db.QueryRowContext(r.Context(), 
		"SELECT id{{range .Fields}}, {{.DBName}}{{end}}, created_at, updated_at FROM {{.TableName}} WHERE id = ?", id).
		Scan(&item.ID{{range .Fields}}, &item.{{.Name | title}}{{end}}, &item.CreatedAt, &item.UpdatedAt)
	
	if err != nil {
		c.App.RenderError(w, "{{.Name}} not found", http.StatusNotFound)
		return
	}
	
	c.App.RenderHTML(w, "{{.ViewPath}}/edit.html", item)
}

func (c *{{.Name}}Controller) Update(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id := vars["id"]
	
	if err := r.ParseForm(); err != nil {
		c.App.RenderError(w, "Invalid form data", http.StatusBadRequest)
		return
	}
	
{{range .Fields}}{{if eq .GoType "bool"}}	{{.DBName}} := r.FormValue("{{.FormName}}") == "true"
{{else if eq .GoType "int64"}}	{{.DBName}} := r.FormValue("{{.FormName}}")
{{else}}	{{.DBName}} := r.FormValue("{{.FormName}}")
{{end}}{{end}}	
	db := c.App.DB()
	_, err := db.ExecContext(r.Context(), 
		"UPDATE {{.TableName}} SET {{range $i, $f := .Fields}}{{if $i}}, {{end}}{{$f.DBName}} = ?{{end}}, updated_at = ? WHERE id = ?",
		{{range .Fields}}{{.DBName}}, {{end}}time.Now(), id)
	
	if err != nil {
		c.App.RenderError(w, "Failed to update {{.VarName}}", http.StatusInternalServerError)
		return
	}
	
	http.Redirect(w, r, "/{{.RoutePath}}/"+id, http.StatusSeeOther)
}

func (c *{{.Name}}Controller) Delete(w http.ResponseWriter, r *http.Request) {
	vars := mux.Vars(r)
	id := vars["id"]
	
	db := c.App.DB()
	_, err := db.ExecContext(r.Context(), "DELETE FROM {{.TableName}} WHERE id = ?", id)
	
	if err != nil {
		c.App.RenderError(w, "Failed to delete {{.VarName}}", http.StatusInternalServerError)
		return
	}
	
	http.Redirect(w, r, "/{{.RoutePath}}", http.StatusSeeOther)
}
